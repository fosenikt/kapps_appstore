<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Login - kApps</title>


	<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
	<link rel="manifest" href="../site.webmanifest">
	<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	
	
	<!-- 
		MaterializeCSS
		Source: https://materializecss.github.io/materialize/getting-started.html
	-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.0.0/dist/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@materializecss/materialize@1.0.0/dist/js/materialize.min.js"></script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

	<script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.min.js"></script>
	<script src="../config.js"></script>
	<script src="/assets/js/remote.js"></script>
	

	<script>
		// Redirect to HTTPS
		if (location.protocol !== 'https:') {
			location.replace(`https:${location.href.substring(location.protocol.length)}`);
		}

		var logging_in = false;
	</script>
	
	
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

	<div class="login-frame" id="login-frame">
		<div class="login-container">
			<div class="login-container-inner">
				<div class="top"></div>
				<div class="center">
					
					<div class="header">
						<img style="max-width:120px;" src="../assets/images/logo/Kapps_no.png" alt="Logo"><br />
						kApps
					</div>


					<div id="login-section-mail" style="padding:20px 35px; display:none;">
						<form id="form-send-link" action="/auth/login/send" method="POST">
							<div class="input-field col s6">
								<input type="email" id="input-mail" name="mail">
								<label for="input-mail">Min e-postadresse</label>
							</div>

							<div class="feedback" id="login-section-mail-feedback"></div>

							<div>
								<button type="submit" class="waves-effect waves-light blue btn">
									Send kode
								</button>
							</div>

							<div class="form-sublink">
								<a href="javascript:show_enter_code();">
									Jeg har en kode
								</a>
							</div>

							<div style="margin-top:45px;">
								<a class="waves-effect waves-light btn white" id="btn-o365-login" href="" style="color:black;">
									<img style="height:25px; vertical-align:middle;" src="../assets/images/icons/office_logo.svg" alt="logo" /> Logg på med Office365
								</a>

								<script type="text/javascript">
									let btn_o365_login = document.getElementById('btn-o365-login');
									btn_o365_login.setAttribute('href', config.api_url + '/login/microsoft/signin.php');
								</script>
							</div>

							<div style="margin-top:15px;">
								<a class="modal-trigger" href="#modal-create-user">Opprett bruker?</a><br />
								<a class="modal-trigger" href="#modal-about-privacy">Om kApps og personvern</a><br />
							</div>
						</form>
					</div>


					<div id="login-section-code" style="padding:20px 35px; display:none;">
						<form id="form-validate-code" action="/auth/login/validate/code" method="POST">

							<div class="help" style="margin-bottom:35px;">
								<i class="fas fa-info-circle"></i> En kode sendes nå til din e-postadresse.
								E-post er ikke det kjappeste, så vær litt tålmodig og sjekk gjerne spam-mappe.
							</div>

							<div class="input-field col s6">
								<input type="hidden" id="input-code-mail" name="mail">
								<input type="tel" id="input-code" name="code">
								<label for="input-mail">Min kode</label>
							</div>

							<div class="feedback" id="login-section-code-feedback"></div>

							<div>
								<button type="submit" class="waves-effect waves-light blue btn">
									Logg inn
								</button>
							</div>

							<div class="form-sublink">
								<a href="javascript:show_enter_mail();">
									Jeg trenger visst en ny kode
								</a>
							</div>
						</form>
					</div>

					<div id="login-section-loader" style="padding:20px 35px; display:block;">
						<i class="fas fa-spinner fa-pulse"></i><br />
						Laster...
					</div>

					
				</div>

				<div class="bottom">
					<p>&copy; 2019 - 2021 Fosen IKT</p>
					<p>
						<b>Problemer med innlogging?</b><br />
						<a href="https://helpdesk.fosenikt.no" target="_blank">Helpdesk Fosen IKT</a>
					</p>
					<!-- <p>Se <a href="https://www.fosenikt.no/home/?page_id=12860" target="_blank">hjelp på vår nettside</a>, dersom du fortsatt har problemer.</p> -->
					<br />
				</div>

			</div>
		</div>
	</div>




	<!-- Modal: Create user -->
	<div id="modal-create-user" class="modal">
		<div class="modal-content">
			<h2>Opprette bruker?</h2>
			<p>Ved lansering av Kapps AppStore har vi lagt inn e-postdomener til nærmere 700 kommuner, fylker, IKS og andre offentlige virksomheter.</p>
			<p>
				<b>Innlogging er åpen for alle med e-post tilhørende en av disse domenene.</b><br />
				Ved å skrive inn din e-postadresse, vil du få tilsendt pinkode for innlogging på e-post.
			</p>
			<p>Vi mangler nok svært mange IKS. En del virksomheter har også forskjellige e-postdomener, enn de bruker på nettside.</p>
			<p>
				<b><a href="https://kapps.no/contact/" target="_blank">Ta kontakt</a> dersom du ikke får logget inn</b>, så skal vi få lagt inn din virksomhet.
			</p>


			<h3>Hvorfor innlogging?</h3>
			<p>
				Innlogging er hovedsaklig for å knytte delte tjenester mot virksomhet, 
				samt minimere skade dersom det lastes opp eller deles tjenester/dokumenter som inneholder sensitiv informasjon.
			</p>
		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close waves-effect waves-green btn-flat">Lukk</a>
		</div>
	</div>


	<!-- Modal: About & Privacy -->
	<div id="modal-about-privacy" class="modal">
		<div class="modal-content">
			<h2>Om kApps og Personvern</h2>

			<p>Du kan lese mer om eksperimentet <a href="https://kapps.no/" target="_blank">Kapps.no her</a>.</p>
			<p>
				Kapps AppStore er en katalog over tjenester som offentlige virksomheter har laget selv.
				Dette kan være alt fra hele applikasjoner, til integrasjoner og dokument som ROS og DPIA.
			</p>
			<p>
				Katalogen baserer seg på selvbetjening, hvor alle* har mulighet til å legge inn egne tjenester.
			</p>
			<p style="font-size:0.7rem;">
				<i>* Alle som har en e-post med offentlig domenenavn, som finnes i Kapps-databasen. Så langt ligger tilnærmet 700 offentlige virksomheter inne.
					 Ta kontakt dersom du ikke får logget inn.
				</i>
			</p>
			

			<h3>Personvern</h3> 

			<p>
				Ved innlogging lagres kun din <b>e-postadresse</b>, sammen med <b>IP-adresse</b> og <b>nettleser (User-agent)</b>.
			</p>

			<p>
				Videre kan du fylle ut brukerprofilen din med <b>fornavn</b>, <b>etternavn</b> og <b>mobilnummer</b>.
			</p>

			<h4>Åpent plattform</h4>
			<p>
				Dette skal være en åpen plattform for alle offentlige virksomheter.
				Som betyr at din brukerprofil, tjenester du legger ut og tilsvarende vil være tilgjengelig for andre i plattformen 
				(altså andre innloggede brukere).
			</p>

			<h4>Statistikk</h4>
			<p>
				Det vil loggføres enkel internt statistikk på hvilke tjenester man klikker på. Formålet er å vise "Mest populær", "Sist settpå" og lignende.
			</p>

			<h4>Ekstern deling av data</h4>
			<p>
				Det vil ikke selges eller gis ut data om brukere til tredjepart. Det finnes API som kan brukes med din egen bruker, basert på dine rettigheter.
				Det kan vurderes åpne API-er for data som er offentlig tilgjengelig (f.eks. virksomheter), men ikke data som kan knyttes mot deg som person.
			</p>


		</div>
		<div class="modal-footer">
			<a href="#!" class="modal-close waves-effect waves-green btn green">Godta</a>
		</div>
	</div>



	<script src="login.js"></script>

	<script type="text/javascript">

		var modal_create_user = M.Modal.init(document.getElementById('modal-create-user'), {});
		var modal_about_privacy = M.Modal.init(document.getElementById('modal-about-privacy'), {
			dismissible: false,
			onCloseEnd: function (modal, trigger) {
				localStorage.setItem('modal_privacy_read', '1');
			}
		});

		if (localStorage.getItem("modal_privacy_read") === null) {
			modal_about_privacy.open();
		}


		// If token exist in URL
		// Get user with API request
		// Redirect if user is found
		if (getParameterByName('c') != '' && getParameterByName('c') != null) {

			// Set login in progress
			logging_in = true;
			show_loader();

			// Store token in local storage
			//localStorage.setItem("user_token", getParameterByName('token'));

			var formData = new FormData();
			formData.append('user_id', getParameterByName('u'));
			formData.append('hash', getParameterByName('c'));
			
			// Check logged in user from API
			remote.rpc_post(config.api_url+'/auth/login/validate/hash', formData).then(response => {
				console.log(response);
				if (response != null) {
					if (response.status == 'success') {
						msg_status('success', 'Wohoo, du er nå innlogget!');
						localStorage.setItem('user_token', response.token);
						window.location.replace(config.app_url);
					}
					else {
						show_enter_mail();
						msg_status('error', 'Kunne ikke validere innlogging');
					}
				}
				else {
					show_enter_mail();
					msg_status('error', 'Ingen respons fra backend');
				}
			})
			
			.catch((err) => {
				show_enter_mail();
				msg_status('error', 'Ugyldig respons fra backend');
			});
		}



		/**
		 * Request code
		 */
		document.querySelector("#form-send-link").addEventListener('submit', event => {
			event.preventDefault();
			event.stopImmediatePropagation(); // Stops event to fire twice

			show_loader();

			let formAction = event.target.getAttribute('action');
			let formData = new FormData(event.target);

			let mail = formData.get('mail');

			remote.rpc_post(config.api_url+formAction, formData).then(response => {
				console.log(response);

				if (response != null) {

					if (response.status == 'success') {
						show_enter_code();

						msg_status('', '');

						document.getElementById('input-code-mail').value = mail;
						document.getElementById('input-code').value = '';
					}

					else {
						show_enter_mail();

						if (response.message == 'Not valid domain') {
							msg_status('error', 'Domenet for din e-postadresse er ikke registrert. <a href="https://kapps.no/contact/" target="_blank">Ta kontakt</a>, så fikser vi :-)');
						}
						else {
							msg_status('error', 'Fant ikke din e-postadresse i vår database. Vennligst ta kontakt.');
						}
					}

				} else {
					show_enter_mail();
					msg_status('error', 'Ingen respons fra backend');
				}
			})

			.catch((err) => {
				console.log(err);
			});

			return false;
		});




		/**
		 * Validate code
		 */
		document.querySelector("#form-validate-code").addEventListener('submit', event => {
			event.preventDefault();
			event.stopImmediatePropagation(); // Stops event to fire twice

			show_loader();

			let formAction = event.target.getAttribute('action');
			let formData = new FormData(event.target);

			remote.rpc_post(config.api_url+formAction, formData).then(response => {
				console.log(response);

				if (response != null) {
					if (response.status == 'success') {
						msg_status('success', 'Wohoo, du er nå innlogget!');
						localStorage.setItem('user_token', response.token);
						window.location.replace(config.app_url);
					}

					else {
						show_enter_code();
						msg_status('error', 'Kunne ikke validere koden');
					}

				} else {
					show_enter_code();
					msg_status('error', 'Ingen respons fra backend');
				}
			})

			.catch((err) => {
				console.log(err);
			});

			return false;
		});




		show_enter_mail();
	</script>


	<!-- 
		jQuery
		Source: https://jquery.com/
	-->
	<script src="/assets/lib/jquery-3.5.1.slim.min.js"></script>

	<script src="https://kit.fontawesome.com/22636c6fcc.js" crossorigin="anonymous"></script>
	<script src="/assets/lib/jsrender.min.js"></script>
</body>
</html>